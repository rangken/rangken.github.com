<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Weak Strong Refernece</title>
    <!-- SEO -->
    <meta name="description" content="Weak Strong Reference">
    <meta name="keywords" content="Java, C#, Obj-C, Programming"/>
    <meta name="author" content="Young.k">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://rangken.github.io/blog/2015/java-reference/">

    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ko_KR/sdk.js#xfbml=1&appId=873345849376888&version=v2.0";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <!-- Google analytics -->
    <script>
  		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  		ga('create', 'UA-58142397-1', 'auto');
  		ga('send', 'pageview');
    </script>
    <script data-ad-client="ca-pub-9512351571435208" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


  <body>

    <header class="site-header">
  <div class="wrapper">
    <img style="float: left" src="/img/jaeyoung.png" />
    <a class="site-title" href="/">
      <div style="float: left; margin-left: 30px;">YOUNG.K<div>
    </a>
    <div style="float: left; width:500px;">
      <a style="float: left;" class="post-link" href="http://rangken.gitbooks.io/nextersstudy1/content/">
        <h4 style="color:#ffffff;"> Study </h4>
      </a>
      <a style="float: left; margin-left: 10px;" class="post-link" href="http://nexters.github.io/Node-Study/">
        <h4 style="color:#ffffff;"> Node.js </h4>
      </a>
      <a style="float: left; margin-left: 10px;" class="post-link" href="http://rangken.gitbooks.io/javastudy/content/index.html">
        <h4 style="color:#ffffff;"> Effective-Java </h4>
      </a>
    </div>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Weak Strong Refernece</h1>
    <p class="post-meta">Jan 8, 2015
      
	 </p>
  </header>

  <article class="post-content">
    <h2 id="weak-strong-reference">Weak Strong Reference</h2>
<ul>
  <li>C++ 과 다르게 Java C# 언어를 사용하면 가비지 컬랙션이라는 메모리 수집 자동화를 만나게 된다. 가비지 컬랙션은 Reachablity 라는 개념을 통해 메모리를 관리하므로 Weak Strong Reference 의 개념을 이해해야 가비지 컬랙터가 잘 동작하도록 만들수 있다.</li>
</ul>

<h3 id="strong">Strong</h3>
<ul>
  <li><em>“keep this in the heap until I don’t point to it anymore”</em></li>
  <li>더이상 특정 객체를 참조하지 않을때까지  힙에서 유지함</li>
  <li>ex) 특정 객체(개) 를 여러 사람이 목줄로 지키고 있다. 한사람도 목줄로 개를 지키지 않는다면 개는 도망간다(dealloc 메모리에서 사라진다)</li>
</ul>

<h3 id="weak">Weak</h3>
<ul>
  <li><em>“keep this as long as someone else points to it strongly”</em></li>
  <li>다른 포인터가 특정 객체를 참조하고 있을때까지만 유지함</li>
  <li>ex) 특정 객체(개) 가 목줄로 묶여있다(강하게 참조되어있음). 아이들이 그냥 개를 가리키고 있다. 여러명의 아이가 개를 가리키고 있지만 만약 개의 목줄이 풀린다면(더이상 강하게 참조되어 있지 않다면)  개는 도망간다(메모리에서 삭제됨). 여러명의 아이가 가리키고 있더라도(약하게 참조) 목줄이 풀린다면(강하게 참조) 메모리에서 삭제된다!</li>
</ul>

<h3 id="case1-objective-c">Case1 (Objective-C)</h3>

<figure class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>__strong id strongObject = &lt;some_object&gt;;
__weak id weakObject = strongObject;
</pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <ol>
    <li>strongOjbect = nil 을 한다면
strongObject 는 더이상 어떤 객체도 참조 하지 않는다. 따라서 <some_object> 는 메모리에서 사라진다.
weakObject 다른 포인트거 특정 객체를 참조하지 않으므로(아무도 특정객체를 참조 x) <some_object> 는 메모리에서 사라진다.</some_object></some_object></li>
    <li>weakObject = nil 을 한다면
 strongObject 는 <some_object> 를 참조하고 있으므로 메모리에서 사라지지 않는다.
 weakObject 는 <some_object>를 더이상 참조 하지 않는다. weakObject 만 nil 이된다.</some_object></some_object></li>
  </ol>
</blockquote>

<h3 id="case2-c">Case2 (C#)</h3>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="n">Fruit</span> <span class="n">apple</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Fruit</span><span class="p">(</span><span class="s">"Apple"</span><span class="p">);</span>
<span class="n">Fruit</span> <span class="n">orange</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Fruit</span><span class="p">(</span><span class="s">"Orange"</span><span class="p">);</span>
    
<span class="n">Fruit</span> <span class="n">fruit1</span> <span class="p">=</span> <span class="n">apple</span><span class="p">;</span>   <span class="c1">// strong reference</span>
<span class="n">WeakReference</span> <span class="n">fruit2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeakReference</span><span class="p">(</span><span class="n">orange</span><span class="p">);</span> <span class="c1">// weak reference</span>
<span class="n">Fruit</span> <span class="n">target</span><span class="p">;</span>
    
<span class="n">target</span> <span class="p">=</span> <span class="n">fruit2</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">Fruit</span><span class="p">;</span>

<span class="n">apple</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">// 강한 참조한것을 null 해도 Fruit fruit1 = apple; 해서 이미 강한 참조하고 있으므로 메모리에서 사라질수없다</span>
<span class="n">orange</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">// WeakReference fruit2 = new Weak.. 에서 참조하고 있지만 약하게 참조하므로 </span>
<span class="c1">//orange = null; 되면 fruit2는 메모리 에서 사라진것을 가리킴</span>

<span class="c1">// 메모리 정리전 fruit1 - Apple , target - Orange</span>
<span class="n">System</span><span class="p">.</span><span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">GCCollectionMode</span><span class="p">.</span><span class="n">Forced</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="n">GC</span><span class="p">.</span><span class="nf">WaitForFullGCComplete</span><span class="p">();</span> <span class="c1">// 가비지 정리</span>
<span class="c1">// 메모리 정리후 fruit - Apple(안사라짐) target - null(약한참조한건 사라짐)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="android-activity-전달">Android Activity 전달</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.example.weaktest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.ref.WeakReference</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSingleton</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">TestSingleton</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="c1">// Strong 하게 연결됨 - 엑티비티가 Finish 되도 계속 참조하므로 메모리에서 안사라짐 </span>
    <span class="kd">public</span> <span class="nc">TestActivity</span> <span class="n">tActivity</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestActivity</span><span class="o">(</span><span class="nc">TestActivity</span> <span class="n">t</span><span class="o">){</span>
        <span class="n">tActivity</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">TestActivity</span> <span class="nf">getTestActivity</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">tActivity</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// Weak 하게 연결됨 - 액티비티가 Finish되면 tActivity2.get() 은 NULL</span>
    <span class="kd">private</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">TestActivity</span><span class="o">&gt;</span> <span class="n">tActivity2</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestActivity2</span><span class="o">(</span><span class="nc">TestActivity</span> <span class="n">t</span><span class="o">){</span>
        <span class="n">tActivity2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">TestActivity</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">TestActivity</span> <span class="nf">getTestActivity2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">tActivity2</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">TestSingleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestSingleton</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>엑티비티를 싱글톤에 잠시 저장 시키는 용도라면 Strong 하게 연결 되면 안되고 Weak 하게 연결 되어야 한다.
    <ul>
      <li>Weak 하게 연결하면 엑티비티가 <em>finish()</em> 된후에 GC 가 실행되면  <em>getTestActivity2()</em> 를 호출하면 <strong>NULL POINTER 가 넘어오게 된다.</strong></li>
      <li>Strong 하게 연결되면 엑티비티가 <em>finish()</em> 된후에도 계속 메모리 참조를 하므로 <strong>GC 에 대상이 되지 않는다</strong></li>
    </ul>
  </li>
</ul>

<h3 id="todo">TODO</h3>
<ul>
  <li>WeakHashMap : ReferenceQueue</li>
  <li>WeakReference 쓰는 경우 예제</li>
</ul>

  </article>

  <!-- Twitter -->
<span class="post-sharing">
  <a href="https://twitter.com/share" class="twitter-share-button" data-size="large">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>



<!-- Reddit -->
<span class="post-sharing" style="margin-right: 32px">
  <script type="text/javascript" src="//www.redditstatic.com/button/button1.js"></script>
</span>
<!-- Facebook -->
<span class="post-sharing">
  <div class="fb-share-button" data-href="http://rangken.github.io/blog/2015/java-reference/" data-layout="button" style="width: 70px;"></div>
</span>


  <div>
		

    

    
    	<div class="post-related">
			Related: <a href="/blog/2015/effective-java-5/">Effective Java 6장 열거형(enum)과 제네릭</a>
        </div>
    
</div>

  <div class="fb-comments" data-href="http://rangken.github.io/blog/2015/java-reference/" data-numposts="5" data-colorscheme="light" data-width="750"></div>


</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Young.k</li>
          <li><a href="mailto:rangken@gmail.com">rangken@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/rangken" target="_blank">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">rangken</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/rangken87" target="_blank">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">rangken87</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
      <!-- footer desctiption <p class="text"></p> -->
      Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a> & <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>
      </div>
    </div>

  </div>
  <div id="fb-root"></div>
</footer>


  </body>

</html>
